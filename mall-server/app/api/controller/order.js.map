{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\order.js"
    ],
    "names": [
        "Base",
        "require",
        "moment",
        "module",
        "exports",
        "listAction",
        "orderList",
        "model",
        "where",
        "user_id",
        "getLoginUserId",
        "page",
        "countSelect",
        "newOrderList",
        "item",
        "data",
        "goodsList",
        "order_id",
        "id",
        "select",
        "goodsCount",
        "forEach",
        "v",
        "number",
        "order_status_text",
        "getOrderStatusText",
        "handleOption",
        "getOrderHandleOption",
        "push",
        "success",
        "detailAction",
        "orderId",
        "get",
        "orderInfo",
        "find",
        "think",
        "isEmpty",
        "fail",
        "province_name",
        "province",
        "getField",
        "city_name",
        "city",
        "district_name",
        "district",
        "full_region",
        "latestExpressInfo",
        "getLatestOrderExpress",
        "express",
        "orderGoods",
        "add_time",
        "unix",
        "format",
        "final_pay_time",
        "order_status",
        "submitAction",
        "addressId",
        "post",
        "checkedAddress",
        "freightPrice",
        "checkedGoodsList",
        "session_id",
        "checked",
        "goodsTotalPrice",
        "cartItem",
        "retail_price",
        "couponId",
        "couponPrice",
        "orderTotalPrice",
        "actualPrice",
        "currentTime",
        "parseInt",
        "getTime",
        "order_sn",
        "generateOrderNumber",
        "consignee",
        "name",
        "mobile",
        "province_id",
        "city_id",
        "district_id",
        "address",
        "freight_price",
        "postscript",
        "coupon_id",
        "coupon_price",
        "goods_price",
        "order_price",
        "actual_price",
        "add",
        "orderGoodsData",
        "goodsItem",
        "goods_id",
        "goods_sn",
        "product_id",
        "goods_name",
        "list_pic_url",
        "market_price",
        "goods_specifition_name_value",
        "goods_specifition_ids",
        "addMany",
        "clearBuyGoods",
        "expressAction"
    ],
    "mappings": ";;AAAA,MAAMA,OAAOC,QAAQ,WAAR,CAAb;AACA,MAAMC,SAASD,QAAQ,QAAR,CAAf;;AAEAE,OAAOC,OAAP,GAAiB,cAAcJ,IAAd,CAAmB;AAClC;;;;AAIMK,YAAN,GAAmB;AAAA;;AAAA;AACjB,YAAMC,YAAY,MAAM,MAAKC,KAAL,CAAW,OAAX,EAAoBC,KAApB,CAA0B,EAAEC,SAAS,MAAKC,cAAL,EAAX,EAA1B,EAA8DC,IAA9D,CAAmE,CAAnE,EAAsE,EAAtE,EAA0EC,WAA1E,EAAxB;AACA,YAAMC,eAAe,EAArB;AACA,WAAK,MAAMC,IAAX,IAAmBR,UAAUS,IAA7B,EAAmC;AACjC;AACAD,aAAKE,SAAL,GAAiB,MAAM,MAAKT,KAAL,CAAW,aAAX,EAA0BC,KAA1B,CAAgC,EAAES,UAAUH,KAAKI,EAAjB,EAAhC,EAAuDC,MAAvD,EAAvB;AACAL,aAAKM,UAAL,GAAkB,CAAlB;AACAN,aAAKE,SAAL,CAAeK,OAAf,CAAuB,aAAK;AAC1BP,eAAKM,UAAL,IAAmBE,EAAEC,MAArB;AACD,SAFD;;AAIA;AACAT,aAAKU,iBAAL,GAAyB,MAAM,MAAKjB,KAAL,CAAW,OAAX,EAAoBkB,kBAApB,CAAuCX,KAAKI,EAA5C,CAA/B;;AAEA;AACAJ,aAAKY,YAAL,GAAoB,MAAM,MAAKnB,KAAL,CAAW,OAAX,EAAoBoB,oBAApB,CAAyCb,KAAKI,EAA9C,CAA1B;;AAEAL,qBAAae,IAAb,CAAkBd,IAAlB;AACD;AACDR,gBAAUS,IAAV,GAAiBF,YAAjB;;AAEA,aAAO,MAAKgB,OAAL,CAAavB,SAAb,CAAP;AArBiB;AAsBlB;;AAEKwB,cAAN,GAAqB;AAAA;;AAAA;AACnB,YAAMC,UAAU,OAAKC,GAAL,CAAS,SAAT,CAAhB;AACA,YAAMC,YAAY,MAAM,OAAK1B,KAAL,CAAW,OAAX,EAAoBC,KAApB,CAA0B,EAAEC,SAAS,OAAKC,cAAL,EAAX,EAAkCQ,IAAIa,OAAtC,EAA1B,EAA2EG,IAA3E,EAAxB;;AAEA,UAAIC,MAAMC,OAAN,CAAcH,SAAd,CAAJ,EAA8B;AAC5B,eAAO,OAAKI,IAAL,CAAU,OAAV,CAAP;AACD;;AAEDJ,gBAAUK,aAAV,GAA0B,MAAM,OAAK/B,KAAL,CAAW,QAAX,EAAqBC,KAArB,CAA2B,EAAEU,IAAIe,UAAUM,QAAhB,EAA3B,EAAuDC,QAAvD,CAAgE,MAAhE,EAAwE,IAAxE,CAAhC;AACAP,gBAAUQ,SAAV,GAAsB,MAAM,OAAKlC,KAAL,CAAW,QAAX,EAAqBC,KAArB,CAA2B,EAAEU,IAAIe,UAAUS,IAAhB,EAA3B,EAAmDF,QAAnD,CAA4D,MAA5D,EAAoE,IAApE,CAA5B;AACAP,gBAAUU,aAAV,GAA0B,MAAM,OAAKpC,KAAL,CAAW,QAAX,EAAqBC,KAArB,CAA2B,EAAEU,IAAIe,UAAUW,QAAhB,EAA3B,EAAuDJ,QAAvD,CAAgE,MAAhE,EAAwE,IAAxE,CAAhC;AACAP,gBAAUY,WAAV,GAAwBZ,UAAUK,aAAV,GAA0BL,UAAUQ,SAApC,GAAgDR,UAAUU,aAAlF;;AAEA,YAAMG,oBAAoB,MAAM,OAAKvC,KAAL,CAAW,eAAX,EAA4BwC,qBAA5B,CAAkDhB,OAAlD,CAAhC;AACAE,gBAAUe,OAAV,GAAoBF,iBAApB;;AAEA,YAAMG,aAAa,MAAM,OAAK1C,KAAL,CAAW,aAAX,EAA0BC,KAA1B,CAAgC,EAAES,UAAUc,OAAZ,EAAhC,EAAuDZ,MAAvD,EAAzB;;AAEA;AACAc,gBAAUT,iBAAV,GAA8B,MAAM,OAAKjB,KAAL,CAAW,OAAX,EAAoBkB,kBAApB,CAAuCM,OAAvC,CAApC;AACAE,gBAAUiB,QAAV,GAAqBhD,OAAOiD,IAAP,CAAYlB,UAAUiB,QAAtB,EAAgCE,MAAhC,CAAuC,qBAAvC,CAArB;AACAnB,gBAAUoB,cAAV,GAA2BnD,OAAO,QAAP,EAAiB,OAAjB,EAA0BkD,MAA1B,CAAiC,OAAjC,CAA3B;AACA;AACA,UAAInB,UAAUqB,YAAV,KAA2B,CAA/B,EAAkC;AAChC;AACArB,kBAAUoB,cAAV,GAA2BnD,OAAO,QAAP,EAAiB,OAAjB,EAA0BkD,MAA1B,CAAiC,OAAjC,CAA3B;AACA;AACA;AACA;AACD;;AAED;AACA,YAAM1B,eAAe,MAAM,OAAKnB,KAAL,CAAW,OAAX,EAAoBoB,oBAApB,CAAyCI,OAAzC,CAA3B;;AAEA,aAAO,OAAKF,OAAL,CAAa;AAClBI,mBAAWA,SADO;AAElBgB,oBAAYA,UAFM;AAGlBvB,sBAAcA;AAHI,OAAb,CAAP;AAlCmB;AAuCpB;;AAED;;;;AAIM6B,cAAN,GAAqB;AAAA;;AAAA;AACnB;AACA,YAAMC,YAAY,OAAKC,IAAL,CAAU,WAAV,CAAlB;AACA,YAAMC,iBAAiB,MAAM,OAAKnD,KAAL,CAAW,SAAX,EAAsBC,KAAtB,CAA4B,EAAEU,IAAIsC,SAAN,EAA5B,EAA+CtB,IAA/C,EAA7B;AACA,UAAIC,MAAMC,OAAN,CAAcsB,cAAd,CAAJ,EAAmC;AACjC,eAAO,OAAKrB,IAAL,CAAU,SAAV,CAAP;AACD;AACD,YAAMsB,eAAe,IAArB;;AAEA;AACA,YAAMC,mBAAmB,MAAM,OAAKrD,KAAL,CAAW,MAAX,EAAmBC,KAAnB,CAAyB,EAAEC,SAAS,OAAKC,cAAL,EAAX,EAAkCmD,YAAY,CAA9C,EAAiDC,SAAS,CAA1D,EAAzB,EAAwF3C,MAAxF,EAA/B;AACA,UAAIgB,MAAMC,OAAN,CAAcwB,gBAAd,CAAJ,EAAqC;AACnC,eAAO,OAAKvB,IAAL,CAAU,OAAV,CAAP;AACD;;AAED;AACA,UAAI0B,kBAAkB,IAAtB;AACA,WAAK,MAAMC,QAAX,IAAuBJ,gBAAvB,EAAyC;AACvCG,2BAAmBC,SAASzC,MAAT,GAAkByC,SAASC,YAA9C;AACD;;AAED;AACA,YAAMC,WAAW,OAAKT,IAAL,CAAU,UAAV,CAAjB;AACA,YAAMU,cAAc,IAApB;AACA,UAAI,CAAChC,MAAMC,OAAN,CAAc8B,QAAd,CAAL,EAA8B,CAE7B;;AAED;AACA,YAAME,kBAAkBL,kBAAkBJ,YAAlB,GAAiCQ,WAAzD,CA7BmB,CA6BmD;AACtE,YAAME,cAAcD,kBAAkB,IAAtC,CA9BmB,CA8ByB;AAC5C,YAAME,cAAcC,SAAS,OAAKC,OAAL,KAAiB,IAA1B,CAApB;;AAEA,YAAMvC,YAAY;AAChBwC,kBAAU,OAAKlE,KAAL,CAAW,OAAX,EAAoBmE,mBAApB,EADM;AAEhBjE,iBAAS,OAAKC,cAAL,EAFO;;AAIhB;AACAiE,mBAAWjB,eAAekB,IALV;AAMhBC,gBAAQnB,eAAemB,MANP;AAOhBtC,kBAAUmB,eAAeoB,WAPT;AAQhBpC,cAAMgB,eAAeqB,OARL;AAShBnC,kBAAUc,eAAesB,WATT;AAUhBC,iBAASvB,eAAeuB,OAVR;AAWhBC,uBAAe,IAXC;;AAahB;AACAC,oBAAY,OAAK1B,IAAL,CAAU,YAAV,CAdI;;AAgBhB;AACA2B,mBAAW,CAjBK;AAkBhBC,sBAAclB,WAlBE;;AAoBhBjB,kBAAUoB,WApBM;AAqBhBgB,qBAAavB,eArBG;AAsBhBwB,qBAAanB,eAtBG;AAuBhBoB,sBAAcnB;AAvBE,OAAlB;;AA0BA;AACA,YAAMtC,UAAU,MAAM,OAAKxB,KAAL,CAAW,OAAX,EAAoBkF,GAApB,CAAwBxD,SAAxB,CAAtB;AACAA,gBAAUf,EAAV,GAAea,OAAf;AACA,UAAI,CAACA,OAAL,EAAc;AACZ,eAAO,OAAKM,IAAL,CAAU,QAAV,CAAP;AACD;;AAED;AACA,YAAMqD,iBAAiB,EAAvB;AACA,WAAK,MAAMC,SAAX,IAAwB/B,gBAAxB,EAA0C;AACxC8B,uBAAe9D,IAAf,CAAoB;AAClBX,oBAAUc,OADQ;AAElB6D,oBAAUD,UAAUC,QAFF;AAGlBC,oBAAUF,UAAUE,QAHF;AAIlBC,sBAAYH,UAAUG,UAJJ;AAKlBC,sBAAYJ,UAAUI,UALJ;AAMlBC,wBAAcL,UAAUK,YANN;AAOlBC,wBAAcN,UAAUM,YAPN;AAQlBhC,wBAAc0B,UAAU1B,YARN;AASlB1C,kBAAQoE,UAAUpE,MATA;AAUlB2E,wCAA8BP,UAAUO,4BAVtB;AAWlBC,iCAAuBR,UAAUQ;AAXf,SAApB;AAaD;;AAED,YAAM,OAAK5F,KAAL,CAAW,aAAX,EAA0B6F,OAA1B,CAAkCV,cAAlC,CAAN;AACA,YAAM,OAAKnF,KAAL,CAAW,MAAX,EAAmB8F,aAAnB,CAAiC,OAAK3F,cAAL,EAAjC,CAAN;;AAEA,aAAO,OAAKmB,OAAL,CAAa,EAAEI,WAAWA,SAAb,EAAb,CAAP;AAvFmB;AAwFpB;;AAED;;;;AAIMqE,eAAN,GAAsB;AAAA;;AAAA;AACpB,YAAMvE,UAAU,OAAKC,GAAL,CAAS,SAAT,CAAhB;AACA,UAAIG,MAAMC,OAAN,CAAcL,OAAd,CAAJ,EAA4B;AAC1B,eAAO,OAAKM,IAAL,CAAU,OAAV,CAAP;AACD;AACD,YAAMS,oBAAoB,MAAM,OAAKvC,KAAL,CAAW,eAAX,EAA4BwC,qBAA5B,CAAkDhB,OAAlD,CAAhC;AACA,aAAO,OAAKF,OAAL,CAAaiB,iBAAb,CAAP;AANoB;AAOrB;AA/KiC,CAApC",
    "file": "..\\..\\..\\src\\api\\controller\\order.js",
    "sourcesContent": [
        "const Base = require('./base.js');\nconst moment = require('moment');\n\nmodule.exports = class extends Base {\n  /**\n   * 获取订单列表\n   * @return {Promise} []\n   */\n  async listAction() {\n    const orderList = await this.model('order').where({ user_id: this.getLoginUserId() }).page(1, 10).countSelect();\n    const newOrderList = [];\n    for (const item of orderList.data) {\n      // 订单的商品\n      item.goodsList = await this.model('order_goods').where({ order_id: item.id }).select();\n      item.goodsCount = 0;\n      item.goodsList.forEach(v => {\n        item.goodsCount += v.number;\n      });\n\n      // 订单状态的处理\n      item.order_status_text = await this.model('order').getOrderStatusText(item.id);\n\n      // 可操作的选项\n      item.handleOption = await this.model('order').getOrderHandleOption(item.id);\n\n      newOrderList.push(item);\n    }\n    orderList.data = newOrderList;\n\n    return this.success(orderList);\n  }\n\n  async detailAction() {\n    const orderId = this.get('orderId');\n    const orderInfo = await this.model('order').where({ user_id: this.getLoginUserId(), id: orderId }).find();\n\n    if (think.isEmpty(orderInfo)) {\n      return this.fail('订单不存在');\n    }\n\n    orderInfo.province_name = await this.model('region').where({ id: orderInfo.province }).getField('name', true);\n    orderInfo.city_name = await this.model('region').where({ id: orderInfo.city }).getField('name', true);\n    orderInfo.district_name = await this.model('region').where({ id: orderInfo.district }).getField('name', true);\n    orderInfo.full_region = orderInfo.province_name + orderInfo.city_name + orderInfo.district_name;\n\n    const latestExpressInfo = await this.model('order_express').getLatestOrderExpress(orderId);\n    orderInfo.express = latestExpressInfo;\n\n    const orderGoods = await this.model('order_goods').where({ order_id: orderId }).select();\n\n    // 订单状态的处理\n    orderInfo.order_status_text = await this.model('order').getOrderStatusText(orderId);\n    orderInfo.add_time = moment.unix(orderInfo.add_time).format('YYYY-MM-DD HH:mm:ss');\n    orderInfo.final_pay_time = moment('001234', 'Hmmss').format('mm:ss');\n    // 订单最后支付时间\n    if (orderInfo.order_status === 0) {\n      // if (moment().subtract(60, 'minutes') < moment(orderInfo.add_time)) {\n      orderInfo.final_pay_time = moment('001234', 'Hmmss').format('mm:ss');\n      // } else {\n      //     //超过时间不支付，更新订单状态为取消\n      // }\n    }\n\n    // 订单可操作的选择,删除，支付，收货，评论，退换货\n    const handleOption = await this.model('order').getOrderHandleOption(orderId);\n\n    return this.success({\n      orderInfo: orderInfo,\n      orderGoods: orderGoods,\n      handleOption: handleOption\n    });\n  }\n\n  /**\n   * 提交订单\n   * @returns {Promise.<void>}\n   */\n  async submitAction() {\n    // 获取收货地址信息和计算运费\n    const addressId = this.post('addressId');\n    const checkedAddress = await this.model('address').where({ id: addressId }).find();\n    if (think.isEmpty(checkedAddress)) {\n      return this.fail('请选择收货地址');\n    }\n    const freightPrice = 0.00;\n\n    // 获取要购买的商品\n    const checkedGoodsList = await this.model('cart').where({ user_id: this.getLoginUserId(), session_id: 1, checked: 1 }).select();\n    if (think.isEmpty(checkedGoodsList)) {\n      return this.fail('请选择商品');\n    }\n\n    // 统计商品总价\n    let goodsTotalPrice = 0.00;\n    for (const cartItem of checkedGoodsList) {\n      goodsTotalPrice += cartItem.number * cartItem.retail_price;\n    }\n\n    // 获取订单使用的优惠券\n    const couponId = this.post('couponId');\n    const couponPrice = 0.00;\n    if (!think.isEmpty(couponId)) {\n\n    }\n\n    // 订单价格计算\n    const orderTotalPrice = goodsTotalPrice + freightPrice - couponPrice; // 订单的总价\n    const actualPrice = orderTotalPrice - 0.00; // 减去其它支付的金额后，要实际支付的金额\n    const currentTime = parseInt(this.getTime() / 1000);\n\n    const orderInfo = {\n      order_sn: this.model('order').generateOrderNumber(),\n      user_id: this.getLoginUserId(),\n\n      // 收货地址和运费\n      consignee: checkedAddress.name,\n      mobile: checkedAddress.mobile,\n      province: checkedAddress.province_id,\n      city: checkedAddress.city_id,\n      district: checkedAddress.district_id,\n      address: checkedAddress.address,\n      freight_price: 0.00,\n\n      // 留言\n      postscript: this.post('postscript'),\n\n      // 使用的优惠券\n      coupon_id: 0,\n      coupon_price: couponPrice,\n\n      add_time: currentTime,\n      goods_price: goodsTotalPrice,\n      order_price: orderTotalPrice,\n      actual_price: actualPrice\n    };\n\n    // 开启事务，插入订单信息和订单商品\n    const orderId = await this.model('order').add(orderInfo);\n    orderInfo.id = orderId;\n    if (!orderId) {\n      return this.fail('订单提交失败');\n    }\n\n    // 统计商品总价\n    const orderGoodsData = [];\n    for (const goodsItem of checkedGoodsList) {\n      orderGoodsData.push({\n        order_id: orderId,\n        goods_id: goodsItem.goods_id,\n        goods_sn: goodsItem.goods_sn,\n        product_id: goodsItem.product_id,\n        goods_name: goodsItem.goods_name,\n        list_pic_url: goodsItem.list_pic_url,\n        market_price: goodsItem.market_price,\n        retail_price: goodsItem.retail_price,\n        number: goodsItem.number,\n        goods_specifition_name_value: goodsItem.goods_specifition_name_value,\n        goods_specifition_ids: goodsItem.goods_specifition_ids\n      });\n    }\n\n    await this.model('order_goods').addMany(orderGoodsData);\n    await this.model('cart').clearBuyGoods(this.getLoginUserId());\n\n    return this.success({ orderInfo: orderInfo });\n  }\n\n  /**\n   * 查询物流信息\n   * @returns {Promise.<void>}\n   */\n  async expressAction() {\n    const orderId = this.get('orderId');\n    if (think.isEmpty(orderId)) {\n      return this.fail('订单不存在');\n    }\n    const latestExpressInfo = await this.model('order_express').getLatestOrderExpress(orderId);\n    return this.success(latestExpressInfo);\n  }\n};\n"
    ]
}