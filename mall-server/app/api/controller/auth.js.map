{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\auth.js"
    ],
    "names": [
        "Base",
        "require",
        "module",
        "exports",
        "loginByWeixinAction",
        "code",
        "post",
        "fullUserInfo",
        "clientIp",
        "ctx",
        "ip",
        "errno",
        "errmsg",
        "data",
        "userInfo",
        "service",
        "login",
        "fail",
        "userId",
        "model",
        "where",
        "weixin_openid",
        "openId",
        "getField",
        "think",
        "isEmpty",
        "add",
        "username",
        "uuid",
        "password",
        "register_time",
        "parseInt",
        "Date",
        "getTime",
        "register_ip",
        "mobile",
        "avatar",
        "avatarUrl",
        "gender",
        "nickname",
        "nickName",
        "newUserInfo",
        "field",
        "id",
        "find",
        "update",
        "last_login_time",
        "last_login_ip",
        "TokenSerivce",
        "sessionKey",
        "create",
        "user_id",
        "success",
        "token",
        "logoutAction"
    ],
    "mappings": ";;AAAA,MAAMA,OAAOC,QAAQ,WAAR,CAAb;;AAEAC,OAAOC,OAAP,GAAiB,cAAcH,IAAd,CAAmB;AAC5BI,qBAAN,GAA4B;AAAA;;AAAA;AAC1B,YAAMC,OAAO,MAAKC,IAAL,CAAU,MAAV,CAAb;AACA,YAAMC,eAAe,MAAKD,IAAL,CAAU,UAAV,CAArB;AACA,YAAME,WAAW,MAAKC,GAAL,CAASC,EAA1B;;AAEA;AACA,YAAM,EAAEC,KAAF,EAASC,MAAT,EAAiBC,MAAMC,QAAvB,KAAoC,MAAM,MAAKC,OAAL,CAAa,QAAb,EAAuB,KAAvB,EAA8BC,KAA9B,CAAoCX,IAApC,EAA0CE,YAA1C,CAAhD;AACA,UAAII,UAAU,CAAd,EAAiB;AACf,eAAO,MAAKM,IAAL,CAAUN,KAAV,EAAiBC,MAAjB,CAAP;AACD;;AAED;AACA,UAAIM,SAAS,MAAM,MAAKC,KAAL,CAAW,MAAX,EAAmBC,KAAnB,CAAyB,EAAEC,eAAeP,SAASQ,MAA1B,EAAzB,EAA6DC,QAA7D,CAAsE,IAAtE,EAA4E,IAA5E,CAAnB;AACA,UAAIC,MAAMC,OAAN,CAAcP,MAAd,CAAJ,EAA2B;AACzB;AACAA,iBAAS,MAAM,MAAKC,KAAL,CAAW,MAAX,EAAmBO,GAAnB,CAAuB;AACpCC,oBAAU,SAASH,MAAMI,IAAN,CAAW,CAAX,CADiB;AAEpCC,oBAAU,EAF0B;AAGpCC,yBAAeC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CAHqB;AAIpCC,uBAAa1B,QAJuB;AAKpC2B,kBAAQ,EAL4B;AAMpCd,yBAAeP,SAASQ,MANY;AAOpCc,kBAAQtB,SAASuB,SAAT,IAAsB,EAPM;AAQpCC,kBAAQxB,SAASwB,MAAT,IAAmB,CARS,EAQN;AAC9BC,oBAAUzB,SAAS0B;AATiB,SAAvB,CAAf;AAWD;;AAED;AACA,YAAMC,cAAc,MAAM,MAAKtB,KAAL,CAAW,MAAX,EAAmBuB,KAAnB,CAAyB,CAAC,IAAD,EAAO,UAAP,EAAmB,UAAnB,EAA+B,QAA/B,EAAyC,QAAzC,EAAmD,UAAnD,CAAzB,EAAyFtB,KAAzF,CAA+F,EAAEuB,IAAIzB,MAAN,EAA/F,EAA+G0B,IAA/G,EAA1B;;AAEA;AACA,YAAM,MAAKzB,KAAL,CAAW,MAAX,EAAmBC,KAAnB,CAAyB,EAAEuB,IAAIzB,MAAN,EAAzB,EAAyC2B,MAAzC,CAAgD;AACpDC,yBAAiBf,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CADmC;AAEpDc,uBAAevC;AAFqC,OAAhD,CAAN;;AAKA,YAAMwC,eAAe,MAAKjC,OAAL,CAAa,OAAb,EAAsB,KAAtB,CAArB;AACA,YAAMkC,aAAa,MAAMD,aAAaE,MAAb,CAAoB,EAAEC,SAASjC,MAAX,EAApB,CAAzB;;AAEA,UAAIM,MAAMC,OAAN,CAAcwB,UAAd,CAAJ,EAA+B;AAC7B,eAAO,MAAKhC,IAAL,CAAU,aAAV,CAAP;AACD;;AAED,aAAO,MAAKmC,OAAL,CAAa,EAAEC,OAAOJ,UAAT,EAAqBnC,UAAU2B,WAA/B,EAAb,CAAP;AA5C0B;AA6C3B;;AAEKa,cAAN,GAAqB;AAAA;;AAAA;AACnB,aAAO,OAAKF,OAAL,EAAP;AADmB;AAEpB;AAlDiC,CAApC",
    "file": "..\\..\\..\\src\\api\\controller\\auth.js",
    "sourcesContent": [
        "const Base = require('./base.js');\n\nmodule.exports = class extends Base {\n  async loginByWeixinAction() {\n    const code = this.post('code');\n    const fullUserInfo = this.post('userInfo');\n    const clientIp = this.ctx.ip;\n\n    // 解释用户数据\n    const { errno, errmsg, data: userInfo } = await this.service('weixin', 'api').login(code, fullUserInfo);\n    if (errno !== 0) {\n      return this.fail(errno, errmsg);\n    }\n\n    // 根据openid查找用户是否已经注册\n    let userId = await this.model('user').where({ weixin_openid: userInfo.openId }).getField('id', true);\n    if (think.isEmpty(userId)) {\n      // 注册\n      userId = await this.model('user').add({\n        username: '微信用户' + think.uuid(6),\n        password: '',\n        register_time: parseInt(new Date().getTime() / 1000),\n        register_ip: clientIp,\n        mobile: '',\n        weixin_openid: userInfo.openId,\n        avatar: userInfo.avatarUrl || '',\n        gender: userInfo.gender || 1, // 性别 0：未知、1：男、2：女\n        nickname: userInfo.nickName\n      });\n    }\n\n    // 查询用户信息\n    const newUserInfo = await this.model('user').field(['id', 'username', 'nickname', 'gender', 'avatar', 'birthday']).where({ id: userId }).find();\n\n    // 更新登录信息\n    await this.model('user').where({ id: userId }).update({\n      last_login_time: parseInt(new Date().getTime() / 1000),\n      last_login_ip: clientIp\n    });\n\n    const TokenSerivce = this.service('token', 'api');\n    const sessionKey = await TokenSerivce.create({ user_id: userId });\n\n    if (think.isEmpty(sessionKey)) {\n      return this.fail('生成 token 失败');\n    }\n\n    return this.success({ token: sessionKey, userInfo: newUserInfo });\n  }\n\n  async logoutAction() {\n    return this.success();\n  }\n};\n"
    ]
}